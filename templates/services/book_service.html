{% extends 'base.html' %}
{% load form_tags %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  #map {
    height: 400px;
    width: 100%;
    margin-bottom: 20px;
  }
  .booking-card {
    background: #fff;
    border-radius: 1.25rem;
    box-shadow: 0 8px 32px rgba(42, 187, 90, 0.09);
    padding: 2rem 2rem 1.5rem 2rem;
    margin-top: 1.5rem;
    border: none;
  }
  .booking-card .form-label {
    font-weight: 600;
    color: #145436;
    margin-bottom: 0.25rem;
  }
  .booking-card input,
  .booking-card select,
  .booking-card textarea {
    border-radius: 0.6rem;
    border: 1px solid #e0e5ea;
    padding: 0.65rem 1rem;
    font-size: 1rem;
    background: #f8fdfb;
  }
  .booking-card input:focus,
  .booking-card select:focus,
  .booking-card textarea:focus {
    border-color: #3bd16f;
    box-shadow: 0 0 0 0.15rem #3bd16f2b;
    background: #fff;
  }
  .booking-card button.btn-success {
    background: linear-gradient(90deg, #42e695 0, #3bb2b8 100%);
    border: none;
    font-size: 1.18rem;
    padding-top: 0.7rem;
    padding-bottom: 0.7rem;
    border-radius: 0.7rem;
    font-weight: 700;
    letter-spacing: 2px;
    margin-top: 1rem;
  }
  .booking-card button.btn-success:hover {
    background: linear-gradient(90deg, #2fec8b 20%, #2aaabe 100%);
  }
  .booking-title {
    font-size: 2.1rem;
    font-weight: 700;
    color: #173d2e;
    text-align: center;
    margin-bottom: 2rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="booking-title">Book a Service</div>
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card booking-card">
        <form method="post" novalidate>
          {% csrf_token %}
          {{ form.non_field_errors }}

          <!-- Choose Service Location -->
          <div class="mb-3">
            <label class="form-label">Booking Type:</label>
            {{ form.service_location }}
            {{ form.service_location.errors }}
          </div>

          <!-- Center Booking -->
          <div class="mb-3" id="center-select-section" style="display:none;">
            <label for="{{ form.service_center.id_for_label }}" class="form-label">Select Service Center:</label>
            {{ form.service_center|add_class:"form-select" }}
          </div>

          <div id="map-container" style="display:none;">
            <div id="map"></div>
            <small>Click a marker to select a service center.</small>
          </div>

          <!-- Home Booking -->
          <div class="mb-3" id="home-fields" style="display:none;">
            <label for="{{ form.home_address.id_for_label }}" class="form-label">Home Address:</label>
            {{ form.home_address|add_class:"form-control" }}
            <label for="{{ form.contact_number.id_for_label }}" class="form-label mt-3">Contact Number:</label>
            {{ form.contact_number|add_class:"form-control" }}
          </div>

          <!-- Other form fields -->
          <div class="mb-3">
            <label class="form-label">Select Service</label>
            {{ form.service|add_class:"form-select" }}
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            {{ form.email|add_class:"form-control" }}
          </div>
          <div class="mb-3">
            <label class="form-label">Pet Name</label>
            {{ form.pet_name|add_class:"form-control" }}
          </div>
          <div class="mb-3">
            <label class="form-label">Pet Type</label>
            {{ form.pet_type|add_class:"form-control" }}
          </div>
          <div class="row mb-3">
            <div class="col">
              <label class="form-label">Booking Date</label>
              {{ form.booking_date|add_class:"form-control" }}
            </div>
            <div class="col">
              <label class="form-label">Booking Time</label>
              {{ form.booking_time|add_class:"form-control" }}
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Additional Notes</label>
            {{ form.notes|add_class:"form-control" }}
          </div>

          <button type="submit" class="btn btn-success w-100">Book Now</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map, markersGroup, userMarker;
let centerMarkers = {};

function toggleBookingFields() {
  const selected = document.querySelector('input[name="service_location"]:checked');
  if (!selected) return;

  const value = selected.value;
  document.getElementById('center-select-section').style.display = value === 'center' ? 'block' : 'none';
  document.getElementById('map-container').style.display = value === 'center' ? 'block' : 'none';
  document.getElementById('home-fields').style.display = value === 'home' ? 'block' : 'none';

  if (value === 'center') setTimeout(() => map?.invalidateSize(), 300);
}

document.querySelectorAll('input[name="service_location"]').forEach(el => {
  el.addEventListener('change', toggleBookingFields);
});

window.onload = () => {
  toggleBookingFields();
  initMap();
};

function initMap() {
  // Fixed user location: Warangal
  const userLat = 17.9455;
  const userLng = 79.5976;

  map = L.map('map').setView([userLat, userLng], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  markersGroup = L.layerGroup().addTo(map);

  // User marker
  userMarker = L.marker([userLat, userLng]).addTo(map)
    .bindPopup("<b>You are here</b><br>Warangal").openPopup();

  // Pet center icon
  const centerIcon = L.icon({
    iconUrl: '/static/images/center_icon.webp', // Change path according to your static files
    iconSize: [20, 20],
    iconAnchor: [15, 30],
    popupAnchor: [0, -30]
  });

  // Fetch nearby centers
  fetch(`/services/nearby-centers/?lat=${userLat}&lng=${userLng}&radius=10`)
    .then(res => res.json())
    .then(data => {
      markersGroup.clearLayers();
      centerMarkers = {};

      data.centers.forEach(center => {
        const marker = L.marker([center.latitude, center.longitude], { icon: centerIcon })
          .bindPopup(`<b>${center.name}</b><br>${center.address}<br>Distance: ${center.distance_km} km`)
          .addTo(markersGroup);

        centerMarkers[center.id] = marker;

        marker.on('click', () => {
          document.getElementById('id_service_center').value = center.id;
        });
      });

      // Dropdown → zoom to marker
      const centerSelect = document.getElementById('id_service_center');
      centerSelect.addEventListener('change', function() {
        const selectedId = this.value;
        const selectedMarker = centerMarkers[selectedId];
        if (selectedMarker) {
          map.setView(selectedMarker.getLatLng(), 15);
          selectedMarker.openPopup();
        }
      });
    })
    .catch(err => console.error('Failed to fetch nearby centers:', err));
}
</script>
{% endblock %}
