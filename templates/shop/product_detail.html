{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} Details{% endblock %}

{% block content %}
<!-- Custom Styles -->
<style>
/* Fonts & Colors */
body, h1, h2, h3, h4, h5, h6, p {
    font-family: 'Inter', 'Roboto', sans-serif;
    color: #2c3e50;
}

h2 {
    font-weight: 700;
    font-size: 2rem;
    margin-bottom: 1rem;
}

p {
    font-size: 1rem;
    line-height: 1.6;
}

/* Container for Image + Info */
.product-container {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
    margin-bottom: 2rem;
    align-items: flex-start;
}

/* Image Styling */
.product-image {
    flex: 0 0 350px;
    border-radius: 15px;
    overflow: hidden;
    transition: transform 0.3s;
}

.product-image img {
    width: 100%;
    height: 350px;
    object-fit: cover;
}

.product-image:hover {
    transform: scale(1.05);
}

/* Info Section */
.product-info {
    flex: 1 1 400px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}

.product-info h2 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.product-info p {
    margin: 0.3rem 0;
}

.price {
    font-size: 1.8rem;
    font-weight: 700;
    color: #27ae60;
    margin: 0.8rem 0;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 1.5rem;
    align-items: center;
}

.action-buttons .btn {
    padding: 12px 22px;
    font-size: 1rem;
    border-radius: 10px;
    transition: all 0.2s;
}

.action-buttons .btn:hover {
    transform: translateY(-2px);
}

.btn-icon {
    font-size: 1.8rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    color: #34495e;
}

.btn-icon:hover {
    transform: translateY(-2px);
}

#wishlist-icon.added {
    color: #e74c3c !important;
}

/* Responsive */
@media (max-width: 768px) {
    .product-container {
        flex-direction: column;
        align-items: center;
    }
    .product-info {
        width: 100%;
    }
}
</style>

<div class="container my-5">

    <!-- Product Image + Info -->
    <div class="product-container">

        <!-- Image -->
        <div class="product-image">
            {% if product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}">
            {% else %}
                <img src="{% static 'images/product_placeholder.png' %}" alt="{{ product.name }}">
            {% endif %}
        </div>

        <!-- Info -->
        <div class="product-info">
            <h2>{{ product.name }}</h2>
            <p><strong>Category:</strong> {{ product.category.name }}</p>
            <p><strong>Store:</strong> {{ product.store.name }}</p>
            <p class="price">₹ {{ product.price|floatformat:2 }}</p>
            {% if product.description %}
                <p>{{ product.description|linebreaks }}</p>
            {% else %}
                <p class="text-muted">No description available.</p>
            {% endif %}

            <!-- Action Buttons -->
            <div class="action-buttons">
                <!-- Buy Now -->
                <a href="{% url 'shop:checkout' %}?model=product&item_id={{ product.pk }}" class="btn btn-success">Buy Now</a>

                <!-- Add to Cart -->
                {% if in_cart %}
                    <a href="{% url 'carts:view' %}" class="btn btn-warning">
                        <i class="fas fa-shopping-cart"></i> Added to Cart – View Cart
                    </a>
                {% else %}
                    <button id="btn-add-to-cart" class="btn btn-primary" data-model="product" data-object-id="{{ product.id }}">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                {% endif %}

                <!-- Wishlist -->
                {% if user.is_authenticated %}
                    <i id="wishlist-icon"
                        class="{% if is_in_wishlist %}fas{% else %}far{% endif %} fa-heart btn-icon"
                        title="{% if is_in_wishlist %}Remove from wishlist{% else %}Add to wishlist{% endif %}"
                        data-object-id="{{ product.id }}"
                        data-model="product"
                        data-url="{% url 'wishlist:toggle_wishlist' %}"></i>
                {% else %}
                    <a href="{% url 'accounts:login' %}" title="Login to add to wishlist">
                        <i class="far fa-heart btn-icon"></i>
                    </a>
                {% endif %}

                <!-- Share -->
                <i id="share-icon" class="fas fa-share-alt btn-icon" title="Share this item"></i>
            </div>

        </div>
    </div>
</div>

<!-- Scripts for AJAX Cart & Wishlist -->
<script>
document.getElementById('btn-add-to-cart')?.addEventListener('click', async function(event) {
    event.preventDefault();
    const button = this;
    const url = "{% url 'carts:add_to_cart' %}";
    const model = button.dataset.model;
    const objectId = button.dataset.objectId;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({ 'model': model, 'object_id': objectId }),
        });
        const data = await response.json();
        if (data.success) {
            const badge = document.getElementById('cart-count');
            if (badge) { badge.textContent = data.count > 0 ? data.count : ''; badge.style.display = data.count > 0 ? 'inline-block' : 'none'; }
            const viewCartBtn = document.createElement('a');
            viewCartBtn.href = "{% url 'carts:view' %}";
            viewCartBtn.className = 'btn btn-warning';
            viewCartBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Added to Cart – View Cart';
            button.parentNode.replaceChild(viewCartBtn, button);
        } else { alert('Failed to add to cart.'); }
    } catch (error) { console.error(error); alert('Error adding to cart.'); }
});

document.querySelectorAll('#wishlist-icon').forEach(icon => {
  icon.addEventListener('click', function() {
    const el = this;
    fetch(el.dataset.url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        'object_id': el.dataset.objectId,
        'model': el.dataset.model,
      }),
    }).then(res => res.json())
      .then(data => {
        if(data.success){
          if(data.added){
            el.classList.remove('far');
            el.classList.add('fas','added');
          } else {
            el.classList.remove('fas','added');
            el.classList.add('far');
          }
          const wishlistCountElem = document.getElementById('wishlist-count');
          if(wishlistCountElem && data.count !== undefined){
            wishlistCountElem.textContent = data.count > 0 ? data.count : '';
            wishlistCountElem.style.display = data.count > 0 ? 'inline-block' : 'none';
          }
        }
      });
  });
});
const shareIcon = document.getElementById('share-icon');

shareIcon?.addEventListener('click', async () => {
    const shareData = {
        title: "{{ product.name }}",
        text: "Check out this product on Dogstore!",
        url: "{{ request.build_absolute_uri }}",
    };

    if (navigator.share) {
        // Mobile / supported browsers
        try {
            await navigator.share(shareData);
            console.log('Shared successfully');
        } catch (err) {
            console.error('Error sharing:', err);
        }
    } else {
        // Fallback for desktop: show prompt to copy link
        const dummyInput = document.createElement('input');
        document.body.appendChild(dummyInput);
        dummyInput.value = shareData.url;
        dummyInput.select();
        document.execCommand('copy');
        document.body.removeChild(dummyInput);
        alert('Link copied to clipboard! You can now share it manually.');
    }
});
</script>

{% endblock %}
